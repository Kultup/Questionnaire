{% extends "admin/base.html" %}

{% block title %}–ú–µ—Ç—Ä–∏–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">üìä –ú–µ—Ç—Ä–∏–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å</h1>
                <div>
                    <button class="btn btn-outline-info me-2" onclick="refreshHealth()">
                        <i class="fas fa-sync-alt"></i> –û–Ω–æ–≤–∏—Ç–∏ –∑–¥–æ—Ä–æ–≤'—è
                    </button>
                    <form method="POST" action="{{ url_for('admin_reset_notification_metrics') }}" class="d-inline">
                        <button type="submit" class="btn btn-outline-warning" onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∏–Ω—É—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏?')">
                            <i class="fas fa-redo"></i> –°–∫–∏–Ω—É—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏
                        </button>
                    </form>
                    
                    <!-- –¢–µ—Å—Ç–æ–≤–∏–π –∞–ª–µ—Ä—Ç –±—É–¥–µ –¥–æ–¥–∞–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ -->
                </div>
            </div>

            <!-- –ó–¥–æ—Ä–æ–≤'—è —Å–∏—Å—Ç–µ–º–∏ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üè• –ó–¥–æ—Ä–æ–≤'—è —Å–∏—Å—Ç–µ–º–∏</h5>
                        </div>
                        <div class="card-body">
                            <div id="system-health" class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                <span>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ metrics_report.performance_metrics.total_sent }}</h4>
                                    <p class="card-text">–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ metrics_report.performance_metrics.total_failed }}</h4>
                                    <p class="card-text">–ù–µ–≤–¥–∞–ª—ñ</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-times-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ "%.1f"|format(metrics_report.performance_metrics.success_rate) }}%</h4>
                                    <p class="card-text">–£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-percentage fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ "%.2f"|format(metrics_report.performance_metrics.average_processing_time) }}—Å</h4>
                                    <p class="card-text">–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clock fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–µ—Ä–≥–∏ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–µ—Ä–≥–∏</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-center">
                                        <h4 class="text-primary">{{ queue_stats.get('pending', 0) }}</h4>
                                        <small class="text-muted">–û—á—ñ–∫—É—é—Ç—å</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <h4 class="text-warning">{{ queue_stats.get('retrying', 0) }}</h4>
                                        <small class="text-muted">–ü–æ–≤—Ç–æ—Ä–Ω—ñ —Å–ø—Ä–æ–±–∏</small>
                                    </div>
                                </div>
                                <div class="col-6 mt-3">
                                    <div class="text-center">
                                        <h4 class="text-success">{{ queue_stats.get('sent', 0) }}</h4>
                                        <small class="text-muted">–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ</small>
                                    </div>
                                </div>
                                <div class="col-6 mt-3">
                                    <div class="text-center">
                                        <h4 class="text-danger">{{ queue_stats.get('failed', 0) }}</h4>
                                        <small class="text-muted">–ù–µ–≤–¥–∞–ª—ñ</small>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <h5 class="text-info">{{ queue_stats.get('ready_for_processing', 0) }}</h5>
                                <small class="text-muted">–ì–æ—Ç–æ–≤—ñ –¥–æ –æ–±—Ä–æ–±–∫–∏</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞—Ö</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <h6>Telegram</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: <strong class="text-success">{{ metrics_report.performance_metrics.telegram_stats.sent }}</strong></span>
                                        <span>–ù–µ–≤–¥–∞–ª—ñ: <strong class="text-danger">{{ metrics_report.performance_metrics.telegram_stats.failed }}</strong></span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <h6>Email</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: <strong class="text-success">{{ metrics_report.performance_metrics.email_stats.sent }}</strong></span>
                                        <span>–ù–µ–≤–¥–∞–ª—ñ: <strong class="text-danger">{{ metrics_report.performance_metrics.email_stats.failed }}</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ê–Ω–∞–ª—ñ–∑ –ø–æ–º–∏–ª–æ–∫ -->
            {% if metrics_report.error_breakdown %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üîç –ê–Ω–∞–ª—ñ–∑ –ø–æ–º–∏–ª–æ–∫</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>–¢–∏–ø –ø–æ–º–∏–ª–∫–∏</th>
                                            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for error_type, count in metrics_report.error_breakdown.items() %}
                                        <tr>
                                            <td>{{ error_type }}</td>
                                            <td><span class="badge bg-danger">{{ count }}</span></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –û—Å—Ç–∞–Ω–Ω—ñ –Ω–µ–≤–¥–∞–ª—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
            {% if failed_notifications %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">‚ùå –û—Å—Ç–∞–Ω–Ω—ñ –Ω–µ–≤–¥–∞–ª—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                                            <th>–¢–∏–ø</th>
                                            <th>–°–ø—Ä–æ–±–∏</th>
                                            <th>–ü–æ–º–∏–ª–∫–∞</th>
                                            <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for notification in failed_notifications %}
                                        <tr>
                                            <td>{{ notification.id }}</td>
                                            <td>{{ notification.user.restaurant_name if notification.user else 'N/A' }}</td>
                                            <td>
                                                <span class="badge bg-secondary">{{ notification.notification_type }}</span>
                                            </td>
                                            <td>{{ notification.retry_count }}</td>
                                            <td>
                                                <small class="text-muted">
                                                    {{ notification.error_message[:50] + '...' if notification.error_message and notification.error_message|length > 50 else notification.error_message or 'N/A' }}
                                                </small>
                                            </td>
                                            <td>
                                                <small>{{ notification.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞—Ö -->
            {% if user_stats %}
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üë• –¢–æ–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Å–ø–æ–≤—ñ—â–µ–Ω—å</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>–†–µ—Å—Ç–æ—Ä–∞–Ω</th>
                                            <th>–ú—ñ—Å—Ç–æ</th>
                                            <th>–í—Å—å–æ–≥–æ</th>
                                            <th>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
                                            <th>–ù–µ–≤–¥–∞–ª—ñ</th>
                                            <th>–£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for stat in user_stats %}
                                        <tr>
                                            <td>{{ stat.restaurant_name }}</td>
                                            <td>{{ stat.city }}</td>
                                            <td>{{ stat.total_notifications }}</td>
                                            <td><span class="badge bg-success">{{ stat.sent_count or 0 }}</span></td>
                                            <td><span class="badge bg-danger">{{ stat.failed_count or 0 }}</span></td>
                                            <td>
                                                {% set success_rate = ((stat.sent_count or 0) / stat.total_notifications * 100) if stat.total_notifications > 0 else 0 %}
                                                <span class="badge {% if success_rate >= 90 %}bg-success{% elif success_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ "%.1f"|format(success_rate) }}%
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function refreshHealth() {
    const healthDiv = document.getElementById('system-health');
    healthDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div><span>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>';
    
    fetch('{{ url_for("admin_notification_health") }}')
        .then(response => response.json())
        .then(data => {
            let statusClass = 'success';
            let statusIcon = 'check-circle';
            
            if (data.status === 'degraded') {
                statusClass = 'warning';
                statusIcon = 'exclamation-triangle';
            } else if (data.status === 'unhealthy') {
                statusClass = 'danger';
                statusIcon = 'times-circle';
            } else if (data.status === 'unknown') {
                statusClass = 'secondary';
                statusIcon = 'question-circle';
            }
            
            let issuesHtml = '';
            if (data.issues && data.issues.length > 0) {
                issuesHtml = '<ul class="mt-2 mb-0">';
                data.issues.forEach(issue => {
                    issuesHtml += `<li class="small">${issue}</li>`;
                });
                issuesHtml += '</ul>';
            }
            
            healthDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${statusIcon} text-${statusClass} me-2"></i>
                    <span class="text-${statusClass}">–°—Ç–∞—Ç—É—Å: ${data.status}</span>
                </div>
                ${issuesHtml}
            `;
        })
        .catch(error => {
            healthDiv.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>';
        });
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–¥–æ—Ä–æ–≤'—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', refreshHealth);

// –û–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∑–¥–æ—Ä–æ–≤'—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
setInterval(refreshHealth, 30000);
</script>
{% endblock %}