{% extends "base.html" %}

{% block title %}QR-–∫–æ–¥ –¥–ª—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è - {{ current_user.restaurant_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-qrcode text-primary me-2"></i>
                QR-–∫–æ–¥ –¥–ª—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
            </h2>
            <a href="{{ url_for('user_dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                –ù–∞–∑–∞–¥ –¥–æ –¥–∞—à–±–æ—Ä–¥—É
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- QR Code Display -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-qrcode me-2"></i>
                    –í–∞—à QR-–∫–æ–¥
                </h5>
            </div>
            <div class="card-body text-center">
                {% if qr_code %}
                <div class="qr-code-container mb-4">
                    <img src="data:image/png;base64,{{ qr_code_base64 }}" 
                         alt="QR –∫–æ–¥ –¥–ª—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è" 
                         class="qr-code-image border rounded p-2 bg-white">
                </div>
                
                <div class="mb-3">
                    <p class="text-muted mb-2">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è:</p>
                    <div class="input-group">
                        <input type="text" class="form-control" 
                               value="{{ survey_url }}" 
                               id="surveyUrl" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyUrl()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success" onclick="downloadQRCode()">
                        <i class="fas fa-download me-1"></i>
                        –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ QR-–∫–æ–¥
                    </button>
                    
                    <!-- Social Share Buttons -->
                    <div class="social-share-section mt-3">
                        <p class="text-muted mb-2 text-center">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è QR-–∫–æ–¥–æ–º:</p>
                        <div class="d-flex gap-2 justify-content-center">
                            <button type="button" class="btn btn-telegram" onclick="shareToTelegram()">
                                <i class="fab fa-telegram-plane me-1"></i>
                                Telegram
                            </button>
                            <button type="button" class="btn btn-viber" onclick="shareToViber()">
                                <i class="fab fa-viber me-1"></i>
                                Viber
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                üí° –ü—ñ–¥–∫–∞–∑–∫–∞: –Ø–∫—â–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, 
                                –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ QR-–∫–æ–¥" —Ç–∞ –ø—Ä–∏–∫—Ä—ñ–ø—ñ—Ç—å —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É
                            </small>
                        </div>
                    </div>
                    
                    <form method="POST" action="{{ url_for('user_regenerate_qr') }}" class="d-inline">
                        <button type="submit" class="btn btn-warning w-100" 
                                onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –°—Ç–∞—Ä–∏–π QR-–∫–æ–¥ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.')">
                            <i class="fas fa-sync-alt me-1"></i>
                            –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ QR-–∫–æ–¥
                        </button>
                    </form>
                </div>
                
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-qrcode fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">QR-–∫–æ–¥ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ</h5>
                    <p class="text-muted mb-4">
                        –°—Ç–≤–æ—Ä—ñ—Ç—å QR-–∫–æ–¥ –¥–ª—è –≤–∞—à–æ–≥–æ –∑–∞–∫–ª–∞–¥—É, —â–æ–± –∫–ª—ñ—î–Ω—Ç–∏ –º–æ–≥–ª–∏ –∑–∞–ª–∏—à–∞—Ç–∏ –≤—ñ–¥–≥—É–∫–∏
                    </p>
                    
                    {% if active_questions_count > 0 %}
                    <form method="POST" action="{{ url_for('user_generate_qr') }}">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus me-1"></i>
                            –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ QR-–∫–æ–¥
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        –°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å —Ç–∞ –∞–∫—Ç–∏–≤—É–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è –¥–ª—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
                    </div>
                    <a href="{{ url_for('user_questions') }}" class="btn btn-primary">
                        <i class="fas fa-question-circle me-1"></i>
                        –ö–µ—Ä—É–≤–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è–º–∏
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –ø–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é
                </h5>
            </div>
            <div class="card-body">
                <div class="instruction-step mb-4">
                    <div class="d-flex align-items-start">
                        <div class="step-number me-3">
                            <span class="badge bg-primary rounded-circle">1</span>
                        </div>
                        <div>
                            <h6 class="fw-bold">–†–æ–∑–¥—Ä—É–∫—É–π—Ç–µ QR-–∫–æ–¥</h6>
                            <p class="text-muted mb-0">
                                –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ç–∞ —Ä–æ–∑–¥—Ä—É–∫—É–π—Ç–µ QR-–∫–æ–¥. –†–æ–∑–º—ñ—Å—Ç—ñ—Ç—å –π–æ–≥–æ –Ω–∞ —Å—Ç–æ–ª–∞—Ö, 
                                –±—ñ–ª—è –∫–∞—Å–∏ –∞–±–æ –≤ —ñ–Ω—à–∏—Ö –∑—Ä—É—á–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö –¥–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="instruction-step mb-4">
                    <div class="d-flex align-items-start">
                        <div class="step-number me-3">
                            <span class="badge bg-primary rounded-circle">2</span>
                        </div>
                        <div>
                            <h6 class="fw-bold">–ö–ª—ñ—î–Ω—Ç–∏ —Å–∫–∞–Ω—É—é—Ç—å –∫–æ–¥</h6>
                            <p class="text-muted mb-0">
                                –ö–ª—ñ—î–Ω—Ç–∏ –º–æ–∂—É—Ç—å –≤—ñ–¥—Å–∫–∞–Ω—É–≤–∞—Ç–∏ QR-–∫–æ–¥ –∫–∞–º–µ—Ä–æ—é —Ç–µ–ª–µ—Ñ–æ–Ω—É –∞–±–æ 
                                —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–º –¥–æ–¥–∞—Ç–∫–æ–º –¥–ª—è —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è QR-–∫–æ–¥—ñ–≤.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="instruction-step mb-4">
                    <div class="d-flex align-items-start">
                        <div class="step-number me-3">
                            <span class="badge bg-primary rounded-circle">3</span>
                        </div>
                        <div>
                            <h6 class="fw-bold">–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</h6>
                            <p class="text-muted mb-0">
                                –ö–ª—ñ—î–Ω—Ç–∏ –ø–æ—Ç—Ä–∞–ø–ª—è—é—Ç—å –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è, –¥–µ –º–æ–∂—É—Ç—å 
                                –æ—Ü—ñ–Ω–∏—Ç–∏ —è–∫—ñ—Å—Ç—å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="instruction-step mb-4">
                    <div class="d-flex align-items-start">
                        <div class="step-number me-3">
                            <span class="badge bg-primary rounded-circle">4</span>
                        </div>
                        <div>
                            <h6 class="fw-bold">–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å</h6>
                            <p class="text-muted mb-0">
                                –ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–≥—É–∫—É –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ Telegram-–±–æ—Ç 
                                —Ç–∞ –∑–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –¥–∞—à–±–æ—Ä–¥—ñ.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>–ü–æ—Ä–∞–¥–∞:</strong> –†–æ–∑–º—ñ—Å—Ç—ñ—Ç—å QR-–∫–æ–¥ –Ω–∞ –≤–∏–¥–Ω–æ–º—É –º—ñ—Å—Ü—ñ —Ç–∞ –¥–æ–¥–∞–π—Ç–µ 
                    –∫–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å: "–û—Ü—ñ–Ω—ñ—Ç—å –Ω–∞—à–µ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è - –≤—ñ–¥—Å–∫–∞–Ω—É–π—Ç–µ QR-–∫–æ–¥!"
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        {% if qr_code %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ QR-–∫–æ–¥—É
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stat-item">
                            <h4 class="text-primary mb-1">{{ total_surveys }}</h4>
                            <p class="text-muted small mb-0">–í—Å—å–æ–≥–æ –≤—ñ–¥–≥—É–∫—ñ–≤</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <h4 class="text-success mb-1">{{ surveys_today }}</h4>
                            <p class="text-muted small mb-0">–°—å–æ–≥–æ–¥–Ω—ñ</p>
                        </div>
                    </div>
                </div>
                
                {% if total_surveys > 0 %}
                <hr>
                <div class="text-center">
                    <p class="text-muted small mb-2">–°–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞</p>
                    <h3 class="text-warning mb-0">
                        <i class="fas fa-star me-1"></i>
                        {{ "%.1f"|format(average_score) }}/10
                    </h3>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Preview Survey -->
{% if active_questions_count > 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2"></i>
                        –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
                    </h5>
                    {% if qr_code %}
                    <a href="{{ request.url_root }}survey/{{ current_user.unique_token }}" 
                       target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-external-link-alt me-1"></i>
                        –í—ñ–¥–∫—Ä–∏—Ç–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="survey-preview bg-light p-4 rounded">
                    <div class="text-center mb-4">
                        <h4 class="text-primary">{{ current_user.restaurant_name }}</h4>
                        <p class="text-muted">{{ current_user.city }}</p>
                        <hr>
                        <h5>–û—Ü—ñ–Ω—ñ—Ç—å —è–∫—ñ—Å—Ç—å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è</h5>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">–Ü–º'—è –æ—Ñ—ñ—Ü—ñ–∞–Ω—Ç–∞ *</label>
                        <input type="text" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è –æ—Ñ—ñ—Ü—ñ–∞–Ω—Ç–∞" disabled>
                    </div>
                    
                    {% for question in active_questions[:3] %}
                    <div class="question-card mb-4">
                        <h6 class="fw-bold mb-3">{{ loop.index }}. {{ question.question_text }}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" disabled>
                                    <label class="form-check-label text-success fw-bold">–¢–∞–∫</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" disabled>
                                    <label class="form-check-label text-danger fw-bold">–ù—ñ</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <textarea class="form-control" rows="2" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä" disabled></textarea>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if active_questions_count > 3 %}
                    <div class="text-center text-muted mb-4">
                        <i class="fas fa-ellipsis-h"></i>
                        <small>... —Ç–∞ —â–µ {{ active_questions_count - 3 }} –ø–∏—Ç–∞–Ω—å</small>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">–ó–∞–≥–∞–ª—å–Ω–µ –≤—Ä–∞–∂–µ–Ω–Ω—è (1-10) *</label>
                        <input type="range" class="form-range" min="1" max="10" value="5" disabled>
                        <div class="d-flex justify-content-between small text-muted">
                            <span>1</span>
                            <span>10</span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-primary" disabled>
                            <i class="fas fa-paper-plane me-1"></i>
                            –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–≥—É–∫
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function downloadQRCode() {
    const qrImage = document.querySelector('.qr-code-image');
    const restaurantName = "{{ current_user.restaurant_name }}";
    
    if (qrImage) {
        // Create a canvas to get clean image data
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size to match image
        canvas.width = qrImage.naturalWidth;
        canvas.height = qrImage.naturalHeight;
        
        // Draw image on canvas
        ctx.drawImage(qrImage, 0, 0);
        
        // Convert to blob and download
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `qr-code-${restaurantName.replace(/\s+/g, '-').toLowerCase()}.png`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 'image/png');
    }
}

function copyUrl() {
    const urlInput = document.getElementById('surveyUrl');
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Show success message
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalHtml;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy URL:', err);
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è');
    }
}

function shareToTelegram() {
    const surveyUrl = document.getElementById('surveyUrl').value;
    const restaurantName = "{{ current_user.restaurant_name }}";
    const message = `üçΩÔ∏è –û—Ü—ñ–Ω—ñ—Ç—å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –≤ "${restaurantName}"!\n\nüì± –í—ñ–¥—Å–∫–∞–Ω—É–π—Ç–µ QR-–∫–æ–¥ –∞–±–æ –ø–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º:\n${surveyUrl}\n\n‚≠ê –í–∞—à–∞ –¥—É–º–∫–∞ –≤–∞–∂–ª–∏–≤–∞ –¥–ª—è –Ω–∞—Å!`;
    
    // Try Web Share API first (works on mobile devices)
    if (navigator.share && navigator.canShare) {
        const qrImage = document.querySelector('.qr-code-image');
        if (qrImage && qrImage.complete) {
            // Convert image to blob
            fetch(qrImage.src)
                .then(response => response.blob())
                .then(blob => {
                    const file = new File([blob], `qr-code-${restaurantName.replace(/\s+/g, '-').toLowerCase()}.png`, { type: 'image/png' });
                    
                    // Check if files can be shared
                    if (navigator.canShare({ files: [file] })) {
                        return navigator.share({
                            title: `QR-–∫–æ–¥ –¥–ª—è "${restaurantName}"`,
                            text: message,
                            files: [file]
                        });
                    } else {
                        // Fallback to sharing just text and URL
                        return navigator.share({
                            title: `QR-–∫–æ–¥ –¥–ª—è "${restaurantName}"`,
                            text: message,
                            url: surveyUrl
                        });
                    }
                })
                .catch(err => {
                    console.log('Web Share API failed:', err);
                    fallbackTelegramShare(message, surveyUrl);
                });
        } else {
            // Share just text if image not loaded
            navigator.share({
                title: `QR-–∫–æ–¥ –¥–ª—è "${restaurantName}"`,
                text: message,
                url: surveyUrl
            }).catch(err => {
                console.log('Web Share API failed:', err);
                fallbackTelegramShare(message, surveyUrl);
            });
        }
    } else {
        // Fallback for desktop browsers
        fallbackTelegramShare(message, surveyUrl);
    }
}

function fallbackTelegramShare(message, surveyUrl) {
    // For Telegram, share just the main message
    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(surveyUrl)}&text=${encodeURIComponent(message)}`;
    window.open(telegramUrl, '_blank');
}

function shareToViber() {
    const surveyUrl = document.getElementById('surveyUrl').value;
    const restaurantName = "{{ current_user.restaurant_name }}";
    const message = `üçΩÔ∏è –û—Ü—ñ–Ω—ñ—Ç—å –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –≤ "${restaurantName}"!\n\nüì± –í—ñ–¥—Å–∫–∞–Ω—É–π—Ç–µ QR-–∫–æ–¥ –∞–±–æ –ø–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º:\n${surveyUrl}\n\n‚≠ê –í–∞—à–∞ –¥—É–º–∫–∞ –≤–∞–∂–ª–∏–≤–∞ –¥–ª—è –Ω–∞—Å!`;
    
    // Try Web Share API first (works on mobile devices)
    if (navigator.share && navigator.canShare) {
        const qrImage = document.querySelector('.qr-code-image');
        if (qrImage && qrImage.complete) {
            // Convert image to blob
            fetch(qrImage.src)
                .then(response => response.blob())
                .then(blob => {
                    const file = new File([blob], `qr-code-${restaurantName.replace(/\s+/g, '-').toLowerCase()}.png`, { type: 'image/png' });
                    
                    // Check if files can be shared
                    if (navigator.canShare({ files: [file] })) {
                        return navigator.share({
                            title: `QR-–∫–æ–¥ –¥–ª—è "${restaurantName}"`,
                            text: message,
                            files: [file]
                        });
                    } else {
                        // Fallback to sharing just text and URL
                        return navigator.share({
                            title: `QR-–∫–æ–¥ –¥–ª—è "${restaurantName}"`,
                            text: message,
                            url: surveyUrl
                        });
                    }
                })
                .catch(err => {
                    console.log('Web Share API failed:', err);
                    fallbackViberShare(message, surveyUrl);
                });
        } else {
            // Share just text if image not loaded
            navigator.share({
                title: `QR-–∫–æ–¥ –¥–ª—è "${restaurantName}"`,
                text: message,
                url: surveyUrl
            }).catch(err => {
                console.log('Web Share API failed:', err);
                fallbackViberShare(message, surveyUrl);
            });
        }
    } else {
        // Fallback for desktop browsers
        fallbackViberShare(message, surveyUrl);
    }
}

function fallbackViberShare(message, surveyUrl) {
    // Try to open Viber with message
    const viberUrl = `viber://forward?text=${encodeURIComponent(message)}`;
    
    // Create temporary link to try opening Viber
    const link = document.createElement('a');
    link.href = viberUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Fallback: copy message to clipboard after a short delay
    setTimeout(() => {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(message).then(() => {
                alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É.\n\n–î–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ QR-–∫–æ–¥—É:\n1. –í—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç —É Viber\n2. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ QR-–∫–æ–¥ –∫–Ω–æ–ø–∫–æ—é –≤–∏—â–µ\n3. –ü—Ä–∏–∫—Ä—ñ–ø—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è');
            }).catch(() => {
                showManualCopyInstructions(message);
            });
        } else {
            showManualCopyInstructions(message);
        }
    }, 1000);
}

function showManualCopyInstructions(message) {
    // Create a modal or alert with instructions
    const instructions = `–î–ª—è –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è –≤ Viber:\n\n1. –°–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ–π —Ç–µ–∫—Å—Ç:\n${message}\n\n2. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ QR-–∫–æ–¥ –∫–Ω–æ–ø–∫–æ—é "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ QR-–∫–æ–¥"\n\n3. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Viber —Ç–∞ –ø—Ä–∏–∫—Ä—ñ–ø—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ —Ç–µ–∫—Å—Ç–æ–º`;
    alert(instructions);
}

function copyUrl() {
    const urlInput = document.getElementById('surveyUrl');
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Show success message
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalHtml;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy URL:', err);
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è');
    }
}

// Auto-hide alerts after 5 seconds
setTimeout(function() {
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(function(alert) {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
}, 5000);
</script>
{% endblock %}

{% block extra_css %}
<style>
.qr-code-image {
    max-width: 300px;
    width: 100%;
    height: auto;
}

.step-number .badge {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.instruction-step {
    border-left: 3px solid #e9ecef;
    padding-left: 1rem;
    margin-left: 15px;
}

.stat-item h4 {
    font-size: 2rem;
    font-weight: bold;
}

.survey-preview {
    max-height: 600px;
    overflow-y: auto;
}

/* Social Share Buttons */
.social-share-section {
    border-top: 1px solid #e9ecef;
    padding-top: 1rem;
}

.btn-telegram {
    background: linear-gradient(135deg, #0088cc, #229ed9);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 136, 204, 0.2);
}

.btn-telegram:hover {
    background: linear-gradient(135deg, #006ba6, #1a7db8);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 136, 204, 0.3);
}

.btn-telegram:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 136, 204, 0.25);
    color: white;
}

.btn-viber {
    background: linear-gradient(135deg, #665cac, #7b6fb0);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(102, 92, 172, 0.2);
}

.btn-viber:hover {
    background: linear-gradient(135deg, #5a4f9a, #6b5f9e);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(102, 92, 172, 0.3);
}

.btn-viber:focus {
    box-shadow: 0 0 0 0.2rem rgba(102, 92, 172, 0.25);
    color: white;
}

.btn-telegram i,
.btn-viber i {
    font-size: 1.1em;
}

@media (max-width: 768px) {
    .qr-code-image {
        max-width: 200px;
    }
    
    .step-number {
        margin-right: 1rem !important;
    }
    
    .social-share-section .d-flex {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .btn-telegram,
    .btn-viber {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}