{% extends "base.html" %}

{% block title %}–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å - {{ current_user.restaurant_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    <i class="fas fa-bell text-primary me-2"></i>
                    –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å
                </h2>
                <p class="text-muted mb-0">
                    –ö–µ—Ä—É–≤–∞–Ω–Ω—è Telegram –±–æ—Ç–æ–º —Ç–∞ Email —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è–º–∏ –ø—Ä–æ –≤—ñ–¥–≥—É–∫–∏
                </p>
            </div>
            <div>
                <a href="{{ url_for('user_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    –ù–∞–∑–∞–¥ –¥–æ –ø–∞–Ω–µ–ª—ñ
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Settings Cards Row -->
<div class="row">
    <!-- Email Settings -->
    <div class="col-lg-6 col-md-12 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-envelope me-2"></i>
                    Email —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('user_email_settings') }}">
                    <div class="mb-3">
                        <label for="email_address" class="form-label">Email –∞–¥—Ä–µ—Å–∞</label>
                        <input type="email" class="form-control" id="email_address" name="email_address" 
                               value="{{ current_user.email_address or '' }}" placeholder="example@domain.com">
                        <div class="form-text">
                            Email –∞–¥—Ä–µ—Å–∞ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–ø—ñ–π –≤—ñ–¥–≥—É–∫—ñ–≤
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_enabled" name="email_enabled" 
                                   {{ 'checked' if current_user.email_enabled else '' }}>
                            <label class="form-check-label" for="email_enabled">
                                –£–≤—ñ–º–∫–Ω—É—Ç–∏ Email —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                            </label>
                        </div>
                        <div class="form-text">
                            –û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∫–æ–ø—ñ—ó –≤—Å—ñ—Ö –≤—ñ–¥–≥—É–∫—ñ–≤ –Ω–∞ email
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        –ó–±–µ—Ä–µ–≥—Ç–∏ Email –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Telegram Bot Settings -->
    <div class="col-lg-6 col-md-12 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    Telegram –±–æ—Ç
                </h5>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="mb-3">
                    <form method="POST" action="{{ url_for('user_bot_settings') }}" style="display: inline;">
                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="fas fa-sync-alt"></i> –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω
                        </button>
                    </form>
                </div>

                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.bot_token.label(class="form-label") }}
                        {{ form.bot_token(class="form-control" + (" is-invalid" if form.bot_token.errors else "")) }}
                        {% if form.bot_token.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.bot_token.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            –í–≤–µ–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω –≤–∞—à–æ–≥–æ Telegram –±–æ—Ç–∞ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –ø—Ä–æ –Ω–æ–≤—ñ –≤—ñ–¥–≥—É–∫–∏.
                        </div>
                    </div>

                    <div class="d-flex flex-wrap gap-2">
                        {{ form.submit(class="btn btn-primary") }}
                        {% if current_user.bot_token %}
                            <button type="button" class="btn btn-outline-danger" onclick="confirmTokenRemoval()">
                                <i class="fas fa-trash me-1"></i>
                                –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–∫–µ–Ω
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Telegram Group Settings Row -->
{% if current_user.bot_token %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram –≥—Ä—É–ø–∏
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <form method="POST" action="{{ url_for('user_telegram_group_settings') }}">
                            <div class="mb-3">
                                <label for="telegram_group_id" class="form-label">ID Telegram –≥—Ä—É–ø–∏</label>
                                <input type="text" class="form-control" id="telegram_group_id" name="telegram_group_id" 
                                       value="{{ current_user.telegram_group_id or '' }}" placeholder="-1001234567890">
                                <div class="form-text">
                                    ID –≥—Ä—É–ø–∏ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å (–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ "-100")
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="telegram_enabled" name="telegram_enabled" 
                                           {{ 'checked' if current_user.telegram_group_id else '' }}>
                                    <label class="form-check-label" for="telegram_enabled">
                                        –£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ –≥—Ä—É–ø—É
                                    </label>
                                </div>
                                <div class="form-text">
                                    –í—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –∫–æ–ø—ñ—ó –≤—ñ–¥–≥—É–∫—ñ–≤ —É Telegram –≥—Ä—É–ø—É
                                </div>
                            </div>

                            <div class="mb-3">
                                <hr>
                                <h6><i class="fas fa-search me-1"></i>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è ID –≥—Ä—É–ø–∏</h6>
                                <p class="text-muted small">
                                    <strong>–ö—Ä–æ–∫ 1:</strong> –î–æ–¥–∞–π—Ç–µ –≤–∞—à–æ–≥–æ –±–æ—Ç–∞ –¥–æ Telegram –≥—Ä—É–ø–∏<br>
                                    <strong>–ö—Ä–æ–∫ 2:</strong> –ù–∞–¥—ñ—à–ª—ñ—Ç—å –±—É–¥—å-—è–∫–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –≥—Ä—É–ø—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "–ü—Ä–∏–≤—ñ—Ç")<br>
                                    <strong>–ö—Ä–æ–∫ 3:</strong> –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ –¥–ª—è –ø–æ—à—É–∫—É –≥—Ä—É–ø
                                </p>
                                <button type="button" class="btn btn-outline-primary" onclick="getAvailableGroups()" id="getGroupsBtn">
                                    <i class="fas fa-search me-1"></i>
                                    –ó–Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≥—Ä—É–ø–∏
                                </button>
                                <div id="groupsList" class="mt-3" style="display: none;">
                                    <div class="alert alert-light">
                                        <h6>–ó–Ω–∞–π–¥–µ–Ω—ñ –≥—Ä—É–ø–∏:</h6>
                                        <div id="groupsContent"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex flex-wrap gap-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>
                                    –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä—É–ø–∏
                                </button>
                                {% if current_user.telegram_group_id %}
                                    <button type="button" class="btn btn-outline-info" onclick="testGroupMessage()">
                                        <i class="fas fa-paper-plane me-1"></i>
                                        –¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                                    </button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    <div class="col-lg-4">
                        <div class="alert alert-info h-100 d-flex align-items-center">
                            <div>
                                <h6><i class="fas fa-lightbulb me-1"></i>–Ø–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –≥—Ä—É–ø—É:</h6>
                                <ol class="mb-0 small">
                                    <li>–î–æ–¥–∞–π—Ç–µ –≤–∞—à–æ–≥–æ –±–æ—Ç–∞ –¥–æ Telegram –≥—Ä—É–ø–∏</li>
                                    <li>–î–∞–π—Ç–µ –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</li>
                                    <li>–û—Ç—Ä–∏–º–∞–π—Ç–µ ID –≥—Ä—É–ø–∏ (@userinfobot)</li>
                                    <li>–í–≤–µ–¥—ñ—Ç—å ID –≥—Ä—É–ø–∏ —Ç–∞ —É–≤—ñ–º–∫–Ω—ñ—Ç—å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Status Cards Row -->
<div class="row mt-4">
    <!-- Email Status -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-envelope me-2"></i>
                    Email —Å—Ç–∞—Ç—É—Å
                </h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3">
                    <strong>–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å:</strong>
                    {% if current_user.email_enabled and current_user.email_address %}
                        <span class="badge bg-success">Email –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</span>
                    {% elif current_user.email_address %}
                        <span class="badge bg-warning">Email –≤–∏–º–∫–Ω–µ–Ω–æ</span>
                    {% else %}
                        <span class="badge bg-secondary">Email –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</span>
                    {% endif %}
                </div>

                {% if current_user.email_address %}
                <div class="mb-3">
                    <strong>Email –∞–¥—Ä–µ—Å–∞:</strong>
                    <div class="input-group">
                        <input type="email" class="form-control" value="{{ current_user.email_address }}" readonly>
                    </div>
                </div>
                {% endif %}

                <div class="alert alert-info mt-auto">
                    <h6><i class="fas fa-lightbulb me-1"></i>–ü—Ä–æ Email —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:</h6>
                    <ul class="mb-0 small">
                        <li>–û—Ç—Ä–∏–º—É–π—Ç–µ –∫–æ–ø—ñ—ó –≤—Å—ñ—Ö –≤—ñ–¥–≥—É–∫—ñ–≤ –Ω–∞ email</li>
                        <li>–ù–∞–ª–∞—à—Ç—É–π—Ç–µ email –∞–¥—Ä–µ—Å—É —Ç–∞ —É–≤—ñ–º–∫–Ω—ñ—Ç—å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</li>
                        <li>Email –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ –∑ Telegram</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Bot Status -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    Telegram –±–æ—Ç —Å—Ç–∞—Ç—É—Å
                </h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3">
                    <strong>–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å:</strong>
                    {% if current_user.bot_token %}
                        <span class="badge bg-success">–¢–æ–∫–µ–Ω –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</span>
                    {% else %}
                        <span class="badge bg-warning">–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</span>
                    {% endif %}
                </div>

                {% if current_user.bot_token %}
                {% if bot_info %}
                <div class="mb-3">
                    <strong>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–æ—Ç–∞:</strong>
                    <div class="mt-2">
                        <div><strong>–Ü–º'—è:</strong> {{ bot_info.first_name }}</div>
                        {% if bot_info.username %}
                        <div><strong>Username:</strong> @{{ bot_info.username }}</div>
                        <div class="mt-2">
                            <small class="text-muted">
                                üí° –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –∑–Ω–∞–π–¥—ñ—Ç—å –±–æ—Ç–∞ 
                                <strong>@{{ bot_info.username }}</strong> –≤ Telegram 
                                —ñ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –π–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è <code>/start</code>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <strong>–¢–æ–∫–µ–Ω:</strong>
                    <div class="input-group">
                        <input type="password" class="form-control" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" id="tokenDisplay" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="showTokenInfo()">
                            <i class="fas fa-info-circle" id="toggleIcon"></i>
                        </button>
                    </div>
                    <small class="text-muted">–¢–æ–∫–µ–Ω –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ –∑ –º—ñ—Ä–∫—É–≤–∞–Ω—å –±–µ–∑–ø–µ–∫–∏</small>
                </div>
                {% endif %}

                <div class="alert alert-info mt-auto">
                    <h6><i class="fas fa-lightbulb me-1"></i>–Ø–∫ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞:</h6>
                    <ol class="mb-0 small">
                        <li>–ù–∞–ø–∏—à—ñ—Ç—å @BotFather –≤ Telegram</li>
                        <li>–í—ñ–¥–ø—Ä–∞–≤—Ç–µ –∫–æ–º–∞–Ω–¥—É /newbot</li>
                        <li>–î–∞–π—Ç–µ –Ω–∞–∑–≤—É –≤–∞—à–æ–º—É –±–æ—Ç—É</li>
                        <li>–î–∞–π—Ç–µ username –±–æ—Ç—É (–º–∞—î –∑–∞–∫—ñ–Ω—á—É–≤–∞—Ç–∏—Å—è –Ω–∞ "bot")</li>
                        <li>–°–∫–æ–ø—ñ—é–π—Ç–µ –æ—Ç—Ä–∏–º–∞–Ω–∏–π —Ç–æ–∫–µ–Ω</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Telegram Group Status -->
    {% if current_user.bot_token %}
    <div class="col-lg-4 col-md-12 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    –°—Ç–∞—Ç—É—Å Telegram –≥—Ä—É–ø–∏
                </h5>
            </div>
            <div class="card-body d-flex flex-column">
                <div class="mb-3">
                    <strong>–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å:</strong>
                    {% if current_user.telegram_group_enabled and current_user.telegram_group_id %}
                        <span class="badge bg-success">–ì—Ä—É–ø–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞</span>
                    {% elif current_user.telegram_group_id %}
                        <span class="badge bg-warning">–ì—Ä—É–ø–∞ –≤–∏–º–∫–Ω–µ–Ω–∞</span>
                    {% else %}
                        <span class="badge bg-secondary">–ì—Ä—É–ø–∞ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞</span>
                    {% endif %}
                </div>

                {% if current_user.telegram_group_id %}
                <div class="mb-3">
                    <strong>ID –≥—Ä—É–ø–∏:</strong>
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ current_user.telegram_group_id }}" readonly>
                    </div>
                </div>
                {% endif %}

                <div class="alert alert-info mt-auto">
                    <h6><i class="fas fa-lightbulb me-1"></i>–ü—Ä–æ –≥—Ä—É–ø–æ–≤—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:</h6>
                    <ul class="mb-0 small">
                        <li>–í—ñ–¥–≥—É–∫–∏ –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å—Å—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ –≤ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç —ñ –≥—Ä—É–ø—É</li>
                        <li>–ë–æ—Ç –ø–æ–≤–∏–Ω–µ–Ω –º–∞—Ç–∏ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –≥—Ä—É–ø—ñ</li>
                        <li>ID –≥—Ä—É–ø–∏ –∑–∞–≤–∂–¥–∏ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ "-100"</li>
                        <li>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function showTokenInfo() {
    alert('–¢–æ–∫–µ–Ω –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ –∑ –º—ñ—Ä–∫—É–≤–∞–Ω—å –±–µ–∑–ø–µ–∫–∏. –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–º—ñ–Ω–∏—Ç–∏ —Ç–æ–∫–µ–Ω, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ñ–æ—Ä–º—É –≤–∏—â–µ.');
}

function confirmTokenRemoval() {
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞? –í–∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç–µ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤—ñ –≤—ñ–¥–≥—É–∫–∏.')) {
        // Create a form to submit token removal
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("user_bot_settings") }}';
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'remove_token';
        
        form.appendChild(actionInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function testGroupMessage() {
    if (confirm('–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É Telegram –≥—Ä—É–ø—É?')) {
        // Create a form to submit test message
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("user_test_group_message") }}';
        
        document.body.appendChild(form);
        form.submit();
    }
}

function getAvailableGroups() {
    const btn = document.getElementById('getGroupsBtn');
    const groupsList = document.getElementById('groupsList');
    const groupsContent = document.getElementById('groupsContent');
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–ü–æ—à—É–∫ –≥—Ä—É–ø...';
    
    fetch('{{ url_for("user_get_available_groups") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
         if (data.success && data.groups.length > 0) {
             let html = '';
             data.groups.forEach(group => {
                 html += `
                     <div class="border rounded p-2 mb-2">
                         <div class="d-flex justify-content-between align-items-center">
                             <div>
                                 <strong>${group.title}</strong><br>
                                 <small class="text-muted">ID: ${group.id}</small>
                             </div>
                             <button type="button" class="btn btn-sm btn-outline-success" 
                                     onclick="copyGroupId('${group.id}', '${group.title}')">
                                 <i class="fas fa-copy me-1"></i>–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏
                             </button>
                         </div>
                     </div>
                 `;
             });
             groupsContent.innerHTML = html;
             groupsList.style.display = 'block';
         } else if (data.success && data.groups.length === 0) {
             let instructionsHtml = '<div class="text-muted">';
             if (data.instructions) {
                 instructionsHtml += '<p><strong>–ì—Ä—É–ø–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</strong></p>';
                 instructionsHtml += '<p>' + data.instructions.replace(/\n/g, '<br>') + '</p>';
             } else {
                 instructionsHtml += '<p>–ì—Ä—É–ø–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –±–æ—Ç –¥–æ–¥–∞–Ω–∏–π –¥–æ –≥—Ä—É–ø–∏ —Ç–∞ –º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –ø—Ä–∞–≤–∞.</p>';
             }
             instructionsHtml += '</div>';
             groupsContent.innerHTML = instructionsHtml;
             groupsList.style.display = 'block';
         } else {
             let errorMsg = '–ü–æ–º–∏–ª–∫–∞: ' + (data.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø');
             if (data.instructions) {
                 errorMsg += '\n\n–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó: ' + data.instructions;
             }
             alert(errorMsg);
         }
     })
    .catch(error => {
        console.error('Error:', error);
        alert('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ —Å–ø–∏—Å–∫—É –≥—Ä—É–ø');
    })
    .finally(() => {
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-search me-1"></i>–ó–Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≥—Ä—É–ø–∏';
    });
}

function copyGroupId(groupId, groupTitle) {
    // Set the group ID in the input field
    document.getElementById('telegram_group_id').value = groupId;
    
    // Show success message
    alert(`ID –≥—Ä—É–ø–∏ "${groupTitle}" —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –ø–æ–ª–µ –≤–≤–æ–¥—É!`);
    
    // Hide the groups list
    document.getElementById('groupsList').style.display = 'none';
}
</script>
{% endblock %}